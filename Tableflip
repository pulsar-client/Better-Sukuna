local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TextChatService = game:GetService("TextChatService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local animator = humanoid:WaitForChild("Animator")

-- [[ 1. CONFIGURATION ]]
local triggerIds = {
    ["16054192884"] = false,
    ["18459183268"] = false,
    ["18459178353"] = false,
    ["17106858586"] = false,
    ["11365563255"] = true,
}

local customAnimId = "rbxassetid://120001337057214"
local customAnimIdNumber = "120001337057214"
local isUltimateActive = false

-- [[ SPEED SETTINGS ]]
local SLOW_SPEED = 0.5 -- Changed from 0.2 to 0.5 (Faster, but still slow-mo)
local NORMAL_SPEED = 1
local currentTargetSpeed = SLOW_SPEED -- This variable controls the speed dynamically

-- [[ 2. CINEMATIC LIGHTING ]]
local colorCorrection = Instance.new("ColorCorrectionEffect")
colorCorrection.Brightness = 0
colorCorrection.Parent = Lighting

local fadeInfo = TweenInfo.new(0.5, Enum.EasingStyle.Cubic, Enum.EasingDirection.Out)
local fadeToBlack = {Brightness = -0.5} 
local fadeToNormal = {Brightness = 0}

-- [[ 3. CHAT SENDER ]]
local function sendChat(msg)
    task.spawn(function()
        local success, err = pcall(function()
            local channel = TextChatService.TextChannels:FindFirstChild("RBXGeneral")
            if channel then channel:SendAsync(msg) end
        end)
        if not success then
            local chatEvents = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
            if chatEvents and chatEvents:FindFirstChild("SayMessageRequest") then
                chatEvents.SayMessageRequest:FireServer(msg, "All")
            end
        end
    end)
end

-- [[ 4. MAIN LOGIC ]]
animator.AnimationPlayed:Connect(function(track)
    local animId = track.Animation.AnimationId
    local idNumber = string.match(animId, "%d+")
    
    if triggerIds[idNumber] then
        if isUltimateActive then return end
        isUltimateActive = true
        
        -- Reset target speed to slow at the start
        currentTargetSpeed = SLOW_SPEED

        -- === A. IMMEDIATE PURGE ===
        for _, t in pairs(animator:GetPlayingAnimationTracks()) do
            t:Stop()
        end

        -- === B. START CINEMATICS ===
        TweenService:Create(colorCorrection, fadeInfo, fadeToBlack):Play()

        -- === C. PLAY CUSTOM ANIMATION ===
        local animObj = Instance.new("Animation")
        animObj.AnimationId = customAnimId
        local customTrack = animator:LoadAnimation(animObj)
        
        customTrack.Priority = Enum.AnimationPriority.Action4
        customTrack.Looped = false
        customTrack:Play()
        customTrack:AdjustSpeed(currentTargetSpeed) 

        -- === D. THE ENFORCER (WHITELIST LOCKOUT) ===
        local heartbeatConnection
        heartbeatConnection = RunService.Heartbeat:Connect(function()
            if not isUltimateActive then 
                if heartbeatConnection then heartbeatConnection:Disconnect() end
                return
            end
            
            -- 1. Whitelist Check (Kill other anims)
            for _, t in pairs(animator:GetPlayingAnimationTracks()) do
                local tId = t.Animation.AnimationId
                local tNumber = string.match(tId, "%d+")
                
                if tNumber ~= customAnimIdNumber then
                    t:Stop()
                end
            end
            
            -- 2. Failsafe: Restart if stopped accidentally
            if not customTrack.IsPlaying and customTrack.TimePosition < (customTrack.Length * 0.9) then
                customTrack:Play()
            end
            
            -- 3. CONSTANT SPEED ENFORCER
            -- This forces the speed to match our variable every single frame.
            -- This fixes the issue where it wouldn't speed up or would slow down randomly.
            if customTrack.IsPlaying then
                customTrack:AdjustSpeed(currentTargetSpeed)
            end
        end)

        -- === E. SEQUENCE TIMING ===
        local delayTime = 1.8

        task.spawn(function()
            -- Msg 1 (0.0s)
            sendChat("“Scale of the dragon!”")
            task.wait(delayTime)
            
            -- Msg 2 (1.8s)
            sendChat("“Recoil!”")
            task.wait(delayTime)

            -- Msg 3 (3.6s)
            sendChat("“Twin meteors!”")
            task.wait(delayTime)

            -- Msg 4 (5.4s) - The Slash
            sendChat("“WORLD CUTTING SLASH!”")
            
            -- Wait a split second after the slash text, then resume normal speed
            task.wait(0.2) 

            -- === SPEED UP ===
            -- We update the variable, and the Heartbeat loop above will apply it instantly
            currentTargetSpeed = NORMAL_SPEED 
            
            -- Wait for the finishing animation (approx 2.5 seconds)
            task.wait(2.5) 
            
            -- === CLEANUP ===
            isUltimateActive = false
            customTrack:Stop()
            if heartbeatConnection then heartbeatConnection:Disconnect() end
            
            -- Restore Lighting
            TweenService:Create(colorCorrection, fadeInfo, fadeToNormal):Play()
        end)
    end
end)
